stages:
  - install
  - lint
  - test
  - build
  - deploy

variables:
  NODE_VERSION: "19.1.0"
  PYTHON_VERSION: "3.11"

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - backend/node_modules/
    - frontend-react/node_modules/
    - frontend-svelte/node_modules/
    - ml-service/venv/

backend-install:
  stage: install
  image: node:${NODE_VERSION}
  script:
    - cd backend
    - npm ci
  artifacts:
    paths:
      - backend/node_modules/

backend-lint:
  stage: lint
  image: node:${NODE_VERSION}
  script:
    - cd backend
    - npm run lint || echo "No lint script configured"
  dependencies:
    - backend-install

backend-test:
  stage: test
  image: node:${NODE_VERSION}
  script:
    - cd backend
    - npm test || echo "No test script configured"
  dependencies:
    - backend-install

frontend-svelte-install:
  stage: install
  image: node:${NODE_VERSION}
  script:
    - cd frontend-svelte
    - npm ci
  artifacts:
    paths:
      - frontend-svelte/node_modules/

frontend-svelte-build:
  stage: build
  image: node:${NODE_VERSION}
  script:
    - cd frontend-svelte
    - npm run build
  artifacts:
    paths:
      - frontend-svelte/dist/
  dependencies:
    - frontend-svelte-install

frontend-react-install:
  stage: install
  image: node:${NODE_VERSION}
  script:
    - cd frontend-react
    - npm ci
  artifacts:
    paths:
      - frontend-react/node_modules/

frontend-react-test:
  stage: test
  image: node:${NODE_VERSION}
  script:
    - cd frontend-react
    - npm test -- --watchAll=false
  dependencies:
    - frontend-react-install

frontend-react-build:
  stage: build
  image: node:${NODE_VERSION}
  script:
    - cd frontend-react
    - npm run build
  artifacts:
    paths:
      - frontend-react/build/
  dependencies:
    - frontend-react-install

ml-service-install:
  stage: install
  image: python:${PYTHON_VERSION}
  script:
    - cd ml-service
    - python -m venv venv
    - source venv/bin/activate
    - pip install -r requirements.txt
  artifacts:
    paths:
      - ml-service/venv/

ml-service-test:
  stage: test
  image: python:${PYTHON_VERSION}
  script:
    - cd ml-service
    - source venv/bin/activate
    - python -m unittest discover || echo "No tests configured"
  dependencies:
    - ml-service-install

deploy:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Deployment would happen here"
  when: manual
  dependencies:
    - backend-install
    - frontend-svelte-build
    - frontend-react-build
    - ml-service-install
